name: Java CI with Maven

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          settings-path: ${{ github.workspace }}
          token: ${{ secrets.GH_PACKAGES_TOKEN }}
          cache: maven
#      - name: Configure Maven settings
#        run: |
#          mkdir -p ~/.m2
#          cat > ~/.m2/settings.xml <<EOF
#          <settings>
#            <servers>
#              <server>
#                <id>github-device-connector</id>
#                <username>${MAVEN_USER}</username>
#                <password>${GH_PACKAGES_TOKEN}</password>
#              </server>
#            </servers>
#            <profiles>
#              <profile>
#                <id>github-packages</id>
#                <repositories>
#                  <repository>
#                    <id>github-device-connector</id>
#                    <url>https://maven.pkg.github.com/${MAVEN_USER}/Device-Connector</url>
#                    <releases><enabled>true</enabled></releases>
#                    <snapshots><enabled>true</enabled></snapshots>
#                  </repository>
#                </repositories>
#              </profile>
#            </profiles>
#            <activeProfiles>
#              <activeProfile>github-packages</activeProfile>
#            </activeProfiles>
#          </settings>
#          EOF
#        env:
#          MAVEN_USER: ${{ github.actor }}
#          GH_PACKAGES_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}
      - name: Copy settings.xml to build context
        run: |
          mkdir -p ci
          cp ${{ github.workspace }}/settings.xml ci/settings.xml
      - name: Build with Maven
        run: mvn -B -U -e -DskipTests --file pom.xml
        env:
          MAVEN_OPTS: -Xmx1024m
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.11.1
      - name: Docker Login
        uses: docker/login-action@v3.6.0
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and push Docker image
        uses: docker/build-push-action@v6.18.0
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/iot-telemetry-ingestion-service:latest
          build-args: |
            GITHUB_ACTOR=${{ github.actor }}
            GITHUB_TOKEN=${{ secrets.GH_PACKAGES_TOKEN }}